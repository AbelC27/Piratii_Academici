{% extends 'app/base.html' %}

{% block title %}Practice Mode - PBMate{% endblock %}

{% block content %}
<div class="container practice-container">
    <div class="page-header">
        <h1>âš¡ Practice Mode</h1>
        <p>Solve these generated problems. Your score isn't saved here.</p>
    </div>

    <!-- Difficulty Selection -->
    <div class="filter-bar">
        <a href="{% url 'practice' %}?difficulty=easy" class="filter-btn difficulty-easy {% if current_difficulty == 'easy' %}active{% endif %}">Easy</a>
        <a href="{% url 'practice' %}?difficulty=medium" class="filter-btn difficulty-medium {% if current_difficulty == 'medium' %}active{% endif %}">Medium</a>
        <a href="{% url 'practice' %}?difficulty=hard" class="filter-btn difficulty-hard {% if current_difficulty == 'hard' %}active{% endif %}">Hard</a>
        <a href="{% url 'practice' %}?difficulty={{ current_difficulty }}" class="filter-btn refresh-btn">ðŸ”„ New Set</a>
        
    </div>

    <!-- Generated Problems Grid -->
    <div class="problems-grid">
        {% for problem in generated_problems %}
        <div class="problem-card" 
             data-practice-id="{{ problem.practice_id }}"
             data-correct-answer="{{ problem.answer }}"> {# Store correct answer here #}
            
            <div class="problem-header">
                 <span class="problem-number">Practice #{{ forloop.counter }}</span>
                 <span class="difficulty-badge difficulty-{{ problem.difficulty|lower }}">
                     {{ problem.difficulty }}
                 </span>
                 <span class="solved-badge" id="status-badge-{{ problem.practice_id }}" style="display: none;"></span> {# Placeholder for status #}
            </div>
            
            <div class="problem-question">
                 <p class="question-text" style="user-select: text;">{{ problem.question }}</p>
            </div>
            
            <div class="problem-input">
                <input 
                    type="text" 
                    class="answer-input" 
                    placeholder="Your answer..."
                    id="answer-{{ problem.practice_id }}"
                >
                <div class="button-container" id="button-container-{{ problem.practice_id }}">
                    <button 
                        class="btn btn-primary check-btn" 
                        onclick="checkPracticeAnswer('{{ problem.practice_id }}')"
                        id="check-btn-{{ problem.practice_id }}"
                    >
                        Check
                    </button>
                    {# Reveal button will be added by JS if needed #}
                </div>
            </div>
             <!-- Feedback area (hidden initially) -->
             <div class="feedback" id="feedback-{{ problem.practice_id }}" style="display: none; margin-top: 1rem;"></div>
        </div>
        {% endfor %}
    </div>
    
</div>

{# Use the same styles as problems.html, plus a few extras #}
<style>
    /* Make container wider for practice mode */
    .practice-container {
        max-width: 1200px !important; 
    }

    /* Styles for filter bar */
    .filter-bar {
        display: flex;
        justify-content: center;
        gap: 0.75rem;
        margin-bottom: 2.5rem;
        flex-wrap: wrap; 
    }
    .filter-btn {
        padding: 0.6rem 1.2rem;
        border-radius: 2rem;
        text-decoration: none;
        font-weight: 600;
        border: 2px solid transparent;
        transition: all 0.3s ease;
        background-color: #f3f4f6; 
        color: #4b5563; 
    }
    .filter-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    }
    .filter-btn.active {
        background-color: #667eea; 
        color: white;
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
    }
    .filter-btn.difficulty-easy { border-color: #6ee7b7; color: #047857; background-color: #d1fae5;}
    .filter-btn.difficulty-medium { border-color: #fcd34d; color: #b45309; background-color: #fef3c7;}
    .filter-btn.difficulty-hard { border-color: #fda4af; color: #9f1239; background-color: #fee2e2;}
    .filter-btn.difficulty-easy.active { background-color: #10b981; border-color: #059669; }
    .filter-btn.difficulty-medium.active { background-color: #f59e0b; border-color: #d97706; }
    .filter-btn.difficulty-hard.active { background-color: #ef4444; border-color: #dc2626; }
    .refresh-btn {
        background-color: #e5e7eb;
        color: #374151;
    }
    .refresh-btn:hover {
         box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    }


    /* Problem Card Styles (Copied from problems.html, slightly adjusted) */
     .problems-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); 
        gap: 1.5rem;
        margin-top: 2rem;
        align-items: start; 
    }
    
    .problem-card {
        background: white; 
        border-radius: 0.75rem;
        padding: 1.5rem;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1); 
        transition: transform 0.2s, box-shadow 0.2s, border 0.3s, background 0.3s;
        border: 1.5px solid #e5e7eb; 
        display: flex;
        flex-direction: column;
        height: 100%; 
    }
    
    .problem-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 10px 15px rgba(0,0,0,0.1); 
    }
        
    .problem-card-correct {
        border-color: #10b981 !important;
        border-width: 2px !important;
        background: linear-gradient(to bottom right, #ffffff, #f0fdf4);
    }
    
    .problem-card-incorrect {
        border-color: #ef4444 !important;
        border-width: 2px !important;
        background: linear-gradient(to bottom right, #ffffff, #fff1f2);
    }

    .problem-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
        flex-wrap: wrap; 
        gap: 0.5rem;
    }
    
    .problem-number {
        font-weight: 600;
        color: #6b7280; 
        font-size: 0.9rem;
    }
    
    .difficulty-badge {
        padding: 0.25rem 0.75rem;
        border-radius: 1rem;
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
        border: 1px solid currentColor; 
    }
        
    .solved-badge { /* Reusing for status */
        padding: 0.25rem 0.75rem;
        border-radius: 1rem;
        font-size: 0.75rem;
        font-weight: 600;
        color: white;
        margin-left: auto; 
    }
    .solved-badge.correct { background-color: #10b981; }
    .solved-badge.incorrect { background-color: #ef4444; }
    .solved-badge.revealed { background-color: #f59e0b; }
       
    .difficulty-easy { background-color: #d1fae5; color: #065f46; }
    .difficulty-medium { background-color: #fef3c7; color: #92400e; }
    .difficulty-hard { background-color: #fee2e2; color: #991b1b; }
    
    .problem-question {
        margin-bottom: 1.5rem;
        flex-grow: 1; 
        display: flex; 
        align-items: center;
        justify-content: center;
    }
    
    .question-text {
        font-size: 1.6rem; 
        font-weight: 600;
        color: #1f2937; 
        text-align: center;
        padding: 1rem;
        background-color: #f9fafb; 
        border-radius: 0.5rem;
        border: 1px solid #e5e7eb; 
        width: 100%; 
    }
    
    .problem-input {
        display: flex;
        gap: 0.5rem;
        margin-bottom: 1rem; 
        margin-top: auto; 
    }
    
    .answer-input {
        flex: 1; 
        padding: 0.75rem;
        border: 2px solid #d1d5db; 
        border-radius: 0.5rem;
        font-size: 1rem;
        outline: none;
        transition: border-color 0.2s, box-shadow 0.2s;
        min-width: 100px; 
    }
    
    .answer-input:focus {
        border-color: #667eea; 
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.2);
    }
    .answer-input:disabled {
        background-color: #f3f4f6;
        cursor: not-allowed;
    }
    
    .button-container {
        display: flex; 
        gap: 0.5rem; 
    }
    
    .check-btn {
        padding: 0.75rem 1.5rem;
        white-space: nowrap;
        background-color: #667eea; 
        color: white;
        border: none;
        cursor: pointer;
        border-radius: 0.5rem;
        font-weight: 600;
        transition: background-color 0.2s, transform 0.1s;
    }
    .check-btn:hover:not(:disabled) {
        background-color: #5a6edc; 
        transform: translateY(-1px);
    }
     .check-btn:disabled {
         background-color: #9ca3af; 
         cursor: not-allowed;
         opacity: 0.7;
     }
    .btn-secondary { /* Style for correct/revealed state */
         background-color: #10b981; 
         color: white;
     }
      .btn-secondary:disabled { /* Keep color when disabled */
          background-color: #10b981;
          opacity: 0.8;
      }
    
    .reveal-btn { 
        padding: 0.75rem 1rem;
        white-space: nowrap;
        background-color: #f59e0b; 
        border: none;
        border-radius: 0.5rem;
        color: white;
        font-weight: 600;
        cursor: pointer;
        transition: background-color 0.2s, transform 0.1s;
    }
    .reveal-btn:hover:not(:disabled) {
        background-color: #d97706; 
        transform: translateY(-1px);
    }
     .reveal-btn:disabled {
         background-color: #9ca3af;
         cursor: not-allowed;
          opacity: 0.7;
     }
        
    .feedback {
        padding: 1rem;
        border-radius: 0.5rem;
        font-weight: 500;
        text-align: center;
        animation: fadeInFeedback 0.4s ease-out;
        border-width: 2px;
        border-style: solid;
    }
    .feedback.correct { background-color: #ecfdf5; color: #065f46; border-color: #10b981; }
    .feedback.incorrect { background-color: #fff1f2; color: #991b1b; border-color: #ef4444; }
    
    @keyframes fadeInFeedback {
        from { opacity: 0; transform: translateY(-5px); }
        to { opacity: 1; transform: translateY(0); }
    }
    
    .feedback-message { font-size: 1.1rem; margin-bottom: 0.5rem; }
    .correct-answer-text { font-size: 0.9rem; color: #4b5563; margin-top: 0.5rem; font-weight: 600; }
     .correct-answer-text code { background-color: rgba(0,0,0,0.05); padding: 0.1em 0.4em; border-radius: 3px; font-family: monospace; }

     @media (max-width: 768px) {
        .filter-bar { gap: 0.5rem; }
        .filter-btn { padding: 0.5rem 1rem; font-size: 0.9rem; }
        .problems-grid { grid-template-columns: 1fr; }
        .page-header h1 { font-size: 2rem; }
    }

</style>

<script>
    function checkPracticeAnswer(practiceId) {
        const input = document.getElementById(`answer-${practiceId}`);
        const feedbackDiv = document.getElementById(`feedback-${practiceId}`);
        const buttonContainer = document.getElementById(`button-container-${practiceId}`);
        const checkBtn = document.getElementById(`check-btn-${practiceId}`);
        const problemCard = checkBtn.closest('.problem-card');
        const statusBadge = document.getElementById(`status-badge-${practiceId}`);

        const userAnswerStr = input.value.trim();
        const correctAnswerStr = problemCard.dataset.correctAnswer; // Get answer from data attribute

        // Clear previous feedback and styles
        feedbackDiv.style.display = 'none';
        feedbackDiv.innerHTML = '';
        problemCard.classList.remove('problem-card-correct', 'problem-card-incorrect');
        statusBadge.style.display = 'none';
        statusBadge.className = 'solved-badge'; // Reset classes

        if (!userAnswerStr) {
            showPracticeFeedback(practiceId, 'incorrect', 'Please enter an answer!');
            problemCard.classList.add('problem-card-incorrect');
            return;
        }

        let isCorrect = false;
        try {
            // Try comparing as numbers first
            const userAnswerNum = parseInt(userAnswerStr);
            const correctAnswerNum = parseInt(correctAnswerStr);
            // Use Number.isFinite to handle potential NaN from parseInt
            if (Number.isFinite(userAnswerNum) && Number.isFinite(correctAnswerNum)) {
                isCorrect = userAnswerNum === correctAnswerNum;
            } else {
                 // Fallback to string comparison if not numbers
                 isCorrect = userAnswerStr === correctAnswerStr;
            }
        } catch (e) {
             // Fallback to string comparison on any error
             isCorrect = userAnswerStr === correctAnswerStr;
        }


        // Remove reveal button if it exists
        const existingRevealBtn = buttonContainer.querySelector('.reveal-btn');
        if (existingRevealBtn) {
            existingRevealBtn.remove();
        }

        if (isCorrect) {
            input.disabled = true;
            checkBtn.textContent = 'âœ“ Correct';
            checkBtn.disabled = true;
            checkBtn.classList.remove('btn-primary');
            checkBtn.classList.add('btn-secondary'); // Use solved style
            problemCard.classList.add('problem-card-correct');
            showPracticeFeedback(practiceId, 'correct', 'ðŸŽ‰ Correct!'); 
            
            // Update status badge
            statusBadge.textContent = 'âœ“ Correct';
            statusBadge.classList.add('correct');
            statusBadge.style.display = 'inline-block';

        } else {
            checkBtn.textContent = 'Try Again';
            checkBtn.disabled = false; // Re-enable
            problemCard.classList.add('problem-card-incorrect');
            showPracticeFeedback(practiceId, 'incorrect', 'âŒ Incorrect. Try again!');

             // Update status badge
            statusBadge.textContent = 'âœ— Incorrect';
            statusBadge.classList.add('incorrect');
            statusBadge.style.display = 'inline-block';

            // Add reveal button
             const revealBtn = document.createElement('button');
             revealBtn.className = 'btn reveal-btn';
             revealBtn.textContent = 'Reveal';
             revealBtn.onclick = () => revealPracticeAnswer(practiceId); 
             buttonContainer.appendChild(revealBtn);

             input.focus();
             input.select();
        }
    }

    function showPracticeFeedback(practiceId, type, message) {
        const feedbackDiv = document.getElementById(`feedback-${practiceId}`);
        feedbackDiv.innerHTML = `<p class="feedback-message">${message}</p>`;
        feedbackDiv.className = `feedback ${type}`; // Apply 'correct' or 'incorrect' class
        feedbackDiv.style.display = 'block';
    }

    function revealPracticeAnswer(practiceId) {
        const input = document.getElementById(`answer-${practiceId}`);
        const buttonContainer = document.getElementById(`button-container-${practiceId}`);
        const checkBtn = document.getElementById(`check-btn-${practiceId}`);
        const revealBtn = buttonContainer.querySelector('.reveal-btn');
        const problemCard = checkBtn.closest('.problem-card');
        const correctAnswerStr = problemCard.dataset.correctAnswer;
        const statusBadge = document.getElementById(`status-badge-${practiceId}`);

        input.value = correctAnswerStr;
        input.disabled = true;

        checkBtn.textContent = 'Revealed';
        checkBtn.disabled = true;
        checkBtn.classList.remove('btn-primary');
        checkBtn.classList.add('btn-secondary'); // Use solved style

        if (revealBtn) {
            revealBtn.remove();
        }

        showPracticeFeedback(practiceId, 'incorrect', `The correct answer was <code>${correctAnswerStr}</code>.`);
        problemCard.classList.add('problem-card-incorrect'); // Keep incorrect style
        problemCard.classList.remove('problem-card-correct');

        // Update status badge
        statusBadge.textContent = 'Revealed';
        statusBadge.className = 'solved-badge revealed'; // Use reveal class
        statusBadge.style.display = 'inline-block';
    }

    // Allow Enter key to submit in practice mode
    document.addEventListener('DOMContentLoaded', function() {
        document.querySelectorAll('.practice-container .answer-input').forEach(input => {
            if (!input.disabled) {
                input.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        e.preventDefault(); 
                        const practiceId = this.id.replace('answer-', '');
                        const checkButton = document.getElementById(`check-btn-${practiceId}`);
                        if (checkButton && !checkButton.disabled) {
                            checkButton.click();
                        }
                    }
                });
            }
        });
    });

</script>

{% endblock %}
